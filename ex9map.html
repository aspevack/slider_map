<!DOCTYPE html>
<html>
<head>
    <title>Map Demo</title>
    
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.2/leaflet.css' />
<!--     <link rel="stylesheet" href="leaflet-slider.css"/> -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.2/leaflet.js'></script>
<!--     <script src="leaflet-slider.js"></script> -->
    <!--Links for Drew's sliders-->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
    <link rel="stylesheet" href="https://jqueryui.com/resources/demos/style.css">
    <!--End of Drew's slider text-->
    
    <!--Importing math for dot product-->
    <script src="http://www.numericjs.com/lib/numeric-1.2.6.min.js"></script>
    
    <!--Add the dataset-->
    <script src='oakland.js'></script>
    
    <style type='text/css'>
    
    body { 
      margin: 0; 
      padding: 0; 
      font-family: Helvetica, sans-serif;
    }
    
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      z-index:-1;
    }
    
    #overlay {
      position: absolute;
      top: 10px;
      left: 80px;
      padding: 20px;
      background-color: rgba(255,255,255,0.9);
      font-size: 24px;
      font-weight: bold;
    }
    
    #red, #green, #blue {
/*     position:'bottomright'; */
    clear: left;
    width: 300px;
    margin: 15px;
  }
  /* Color slider stylings*/
  #swatch {
    width: 120px;
    height: 100px;
    margin-top: 18px;
    margin-left: 350px;
    background-image: none;
    z-index: 10;
  }
  #red .ui-slider-range { background: #ffffff; }
  /*#red .ui-slider-handle { border-color: #ef2929; }*/
  #green .ui-slider-range { background: #ffffff; }
/*   #green .ui-slider-handle { border-color: #8ae234; } */
  #blue .ui-slider-range { background: #ffffff; }
/*   #blue .ui-slider-handle { border-color: #729fcf; } */
  
    </style>
</head>

<body>

    <div id="map"></div>
    
    <!--<img src="MapLegend.png" style="padding-right: 5px; z-index: 0; position: absolute; bottom: 124px; right: 0px;">-->
    <div id="red"></div>
    <div id="green"></div>
    <div id="blue"></div>
<!--     <div id="swatch" class="ui-widget-content ui-corner-all"></div> -->
    <script type="text/javascript">
    
    //*******
    //PREPARING THE DATASET
    
    //These are the variable names within the dataset:
    //'ix_auto_p', 'ix_buvi_p', 'ix_disad_p', 'ix_fupo_p', 'ix_luco_p', 'ix_lufe_p', 'ix_res_p', 'ix_tcco_p', 'ix_tcfe_p', 'sc_all'
    
    //Add a new array with the indices
    dataset.features = dataset.features.map(function(e) { 
    e.properties.vector = [e.properties.ix_auto_p,
                e.properties.ix_buvi_p,
                e.properties.ix_disad_p,
                e.properties.ix_fupo_p,
                e.properties.ix_luco_p,
                e.properties.ix_lufe_p,
                e.properties.ix_res_p,
                e.properties.ix_tcco_p,
                e.properties.ix_tcfe_p,
                e.properties.sc_all]; 
    return e;
    });  
    
    //Initialize the weights variable so that we can initialize the popups
    var weights = [1,0,0,0,0,0,0,0,0,0];
    
    //Take the dot product of the weights and index values and put in variable weightedValue
    function updateValue() {
      dataset.features = dataset.features.map(function(e) { 
        e.properties.weightedValue = numeric.dot(e.properties.vector, weights); 
        return e;
      });  
    }
    
    updateValue();
  
    function preprocess() {

//The following code is from 'The Bay Area Zip Code Singles Map.html', might help us
    // Let's get a distribution for the scale
//     var values = map_data.values();
//     for(var i = 0, ilen = values.length; i < ilen; i++) {
//       try {
//         var population = currentPopulation(values[i], 'women') + currentPopulation(values[i], 'men');
//         populations.push(population);
//       } catch(e) {
//         //console.log("Failed on ", values[i]);
//       }
//     }
//     populations = populations.sort(function(a,b) { return a - b; });
//     opacityScale.domain([
//       populations[parseInt(populations.length * 0.0)],
//       populations[parseInt(populations.length * 0.2)],
//       populations[parseInt(populations.length * 0.45)],
//       populations[parseInt(populations.length * 0.6)],
//       populations[parseInt(populations.length * 0.75)],
//       populations[parseInt(populations.length * 0.9)],
//     ])
  }
  
  toggle = 'blue';
  
  function getColor(feature) {
    if(toggle === 'blue') {
      return 'red';}
    else {
      return 'blue';}
  }
  
  function mapStyle(feature) {
    return {
        fillColor: getColor(feature),
        weight: 0,
        opacity: 1,
        //fillOpacity: getOpacity(data),
        fillOpacity: 1,
    };
  }
  
  function colorMap() {
    if(!overlay)
      return;
    //preprocess();
    overlay.setStyle(mapStyle);
  }
    //***********************************************
    // SET UP THE BACKGROUND MAP

    // create the Leaflet map container
    var map = L.map('map');
    
    // define a function to automate setting up Mapbox layers
    function setUpMapboxLayer(id, token) {
        return L.tileLayer('https://{s}.tiles.mapbox.com/v4/' + id + '/{z}/{x}/{y}.png?access_token=' + token, {
            attribution: '&copy; <a href="https://www.mapbox.com/map-feedback/">Mapbox</a> &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap contributors</a>'
        });
    }
    
    // set up some tile layers and add one to the map
    var normalBasemap = setUpMapboxLayer('leereis.o64o8a6a', 'pk.eyJ1IjoibGVlcmVpcyIsImEiOiJjaWdsNHkyaWEwMThhdXJrcmt0bXp6a2Z0In0.FdOBAP8wZrYj2hEohJGMpw');

    map.addLayer(normalBasemap);
    
    //*******Slider script for color
      function hexFromRGB(r, g, b) {
        var hex = [
          r.toString( 16 ),
          g.toString( 16 ),
          b.toString( 16 )
        ];
        $.each( hex, function( nr, val ) {
          if ( val.length === 1 ) {
            hex[ nr ] = "0" + val;
          }
        });
        return hex.join( "" ).toUpperCase();
      }

    
    //***********************************************
    // 1. CREATE OVERLAY 

    // specify what the circle markers should look like
    
    function overlayStyles(color) {
      var style = {
        //radius: 6,
        // fill styles
        fillColor: color, fillOpacity: 0.8,
        // border styles
        color: 'black', opacity: 1, weight: 1
      };
      return style;
    }    
        
    //Updates the popup whenever a block group is clicked
    function whenClicked(e) {
      // e = event
//       test = e
//       console.log(e);
      e.target.bindPopup(
        '<b>id: </b>' + e.target.feature.id + '<br />' + 
        '<b>ix_auto_p: </b>' + e.target.feature.properties.ix_auto_p + '<br />' + 
        '<b>ix_disad_p: </b>' + e.target.feature.properties.ix_disad_p + '<br />' + 
        '<b>value: </b>' + e.target.feature.properties.weightedValue + '<br />'
      );
    }
    
    // specify how to load the individual features 
    var overlayOptions = { 
        onEachFeature: function (feature, layer) {
            layer.bindPopup('<b>id: </b>' + feature.id + '<br />' + 
                            '<b>ix_auto_p: </b>' + feature.properties.ix_auto_p + '<br />' + 
                            '<b>ix_disad_p: </b>' + feature.properties.ix_disad_p + '<br />' + 
                            '<b>value: </b>' + feature.properties.weightedValue + '<br />'
                            );
            layer.on({
              click: whenClicked
            });
        },
        pointToLayer: function (feature, latlng) {
            return L.polygon(latlng, overlayStyles('green'));
        }
    };
    
    // create the layer and add to map
    var overlay = L.geoJson(dataset, overlayOptions); 
    map.addLayer(overlay);
    
    // fit the map window to the data points
    map.fitBounds(overlay.getBounds());
    
    /*Define the function that will take in our weights and output a final index*/
    function updateWeights() {
      weights = [
        $( "#red" ).slider( "value" ),
        $( "#green" ).slider( "value" ),
        $( "#blue" ).slider( "value" ),
        0,
        0,
        0,
        0,
        0,
        0,
        0
      ];
    }
    
    function updateDisplay() {
        //console.log('In theory, want to close any open popups here')
        //The following line doesn't close any open popups :-(
        //overlay.closePopup
    }
    
    /*Slider functions*/
    
//       function updateLayer() {
//       var red = $( "#red" ).slider( "value" ),
//           green = $( "#green" ).slider( "value" ),
//           blue = $( "#blue" ).slider( "value" ), 
//           hex = hexFromRGB( red, green, blue );
//       overlay.setStyle({
//             //weight: 2,
//             //color: '#666',
//             fillColor: "#" + hex
//         });
//       }
      
      function refreshBlockGroups() {
        updateWeights();
        updateValue();
        updateDisplay();
      }
      
      $(function() {
        $( "#red, #green, #blue" ).slider({
          orientation: "horizontal",
          range: "max",
          min: -1,
          max: 1,
          step: 0.1,
          value: 0,
          slide: refreshBlockGroups,
          change: refreshBlockGroups
        });
        $( "#red" ).slider( "value", 1 );
//         $( "#green" ).slider( "value", 140 );
//         $( "#blue" ).slider( "value", 60 );
      });

    
    //map.on('moveend', function() { 
    // alert(map.getBounds().toBBoxString());
    //});
    
    </script>
</body>
</html>